---
# process-template.yml
# Processes individual template files and builds workflow manager configuration

- name: Extract template metadata for {{ template_file.path | basename }}
  set_fact:
    template_name: "{{ template_file.path | basename }}"
    template_content_raw: "{{ lookup('file', template_file.path) | replace('{{ TEMPLATE_PROJECT_NAME }}', projectName) }}"
    commit_message: "{{ template_git_log.results[template_idx].stdout[:catc_template_summary_maxchar] if template_git_log.results[template_idx].stdout else 'Synced from Git' }}"
    diff_content_raw: "{{ template_git_diff.results[template_idx].stdout | regex_replace('([^\\n]+)', '{## \\1 ##}') + '\\n' if include_diff_header else '' }}"

- name: Wrap template content with raw tags for {{ template_name }}
  set_fact:
    template_content: "{{ diff_content_raw }}{{ template_content_raw }}"

- name: Build template workflow configuration for {{ template_name }}
  set_fact:
    template_workflow_configs: "{{ template_workflow_configs | default([]) + [template_config] }}"
  vars:
    template_config:
      configuration_templates:
        template_name: "{{ template_name }}"
        project_name: "{{ projectName }}"
        language: "JINJA"
        template_content: "{{ template_content }}"
        #template_content_file_path: "{{ processed_template_path }}"
        template_description: "Template synced from Git repository"
        device_types: "{{ default_device_types }}"
        software_type: "{{ default_software_type }}"
        software_variant: "{{ default_software_variant }}"
        software_version: null
        template_params: []
        failure_policy: "ABORT_TARGET_ON_ERROR"
        version: "{{ default_template_version }}"
        tags: []
